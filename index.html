<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÄ±ÈñìTO DO„Ç´„É¨„É≥„ÉÄ„Éº„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .calendar-container {
            background: white;
            border-radius: 20px;
            max-width: 1200px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .week-info {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .calendar-sidebar {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            padding: 20px;
        }
        
        .week-calendar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .week-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .day-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .day-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .day-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .day-item.completed {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .day-item.active.completed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .day-header {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .day-date {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        .todo-count {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .day-item.completed .todo-count {
            background: #28a745;
        }
        
        .todo-preview {
            font-size: 0.8rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }
        
        .chat-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .chat-subtitle {
            font-size: 0.9rem;
            color: #666;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .bot-message {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-left: auto;
            max-width: 70%;
            text-align: right;
        }
        
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .input-container input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.3s;
            font-size: 1rem;
        }
        
        .input-container input:focus {
            border-color: #667eea;
        }
        
        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-button:hover {
            transform: scale(1.1);
        }
        
        .choices {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .choice-button {
            background: #e9ecef;
            border: 2px solid #e9ecef;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .choice-button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .summary-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .summary-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .summary-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
        }
        
        .welcome-message {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        
        .welcome-message h2 {
            color: #333;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .calendar-sidebar {
                width: 100%;
                height: 300px;
            }
            
            .calendar-container {
                height: 100vh;
            }
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <div class="header">
            <div class="week-info" id="weekInfo">2024Âπ¥ Á¨¨1ÈÄ±</div>
            <h1>üìÖ ÈÄ±ÈñìTO DO„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà</h1>
            <p>ÊØéÊó•„ÅÆ„Çø„Çπ„ÇØ„ÇíÂØæË©±ÂΩ¢Âºè„ÅßÁÆ°ÁêÜ„Åó„Åæ„Åó„Çá„ÅÜ</p>
        </div>

    <!-- Google Calendar APIË™≠„ÅøËæº„Åø -->
    <script src="https://apis.google.com/js/api.js" onload="initializeGoogleCalendar()"></script>
        
        <div class="main-content">
            <div class="calendar-sidebar">
                <div class="week-calendar">
                    <div class="week-header">‰ªäÈÄ±„ÅÆTO DO</div>
                    <div id="daysList"></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    
                    <!-- TO DOÁ∑®ÈõÜ„Éú„Çø„É≥ -->
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="openTodoEditor()" style="padding: 10px 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; width: 100%;">
                            ‚úèÔ∏è TO DO„ÇíÁ∑®ÈõÜ
                        </button>
                    </div>
                </div>
                
                <div class="summary-panel">
                    <div class="summary-title">üìä ÈÄ±Èñì„Çµ„Éû„É™„Éº</div>
                    <div class="summary-stat">
                        <span class="stat-label">ÂÆå‰∫Ü„Åó„ÅüÊó•:</span>
                        <span class="stat-value" id="completedDays">0/7</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Á∑è„Çø„Çπ„ÇØÊï∞:</span>
                        <span class="stat-value" id="totalTasks">0</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">ÂÆå‰∫Ü„Çø„Çπ„ÇØ:</span>
                        <span class="stat-value" id="completedTasks">0</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">ÈÅîÊàêÁéá:</span>
                        <span class="stat-value" id="achievementRate">0%</span>
                    </div>
                    
                    <!-- „Éá„Éº„ÇøÁÆ°ÁêÜ„Éú„Çø„É≥ -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                        <div style="font-size: 0.9rem; font-weight: bold; margin-bottom: 10px; color: #333;">
                            üíæ „Éá„Éº„ÇøÁÆ°ÁêÜ
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button onclick="exportData()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                                üì• „Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                            </button>
                            <label style="padding: 8px 12px; background: #007bff; color: white; border-radius: 5px; font-size: 0.8rem; cursor: pointer; text-align: center;">
                                üì§ „Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà
                                <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                            </label>
                            <button onclick="clearData()" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                                üóëÔ∏è „Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
                            </button>
                            <button onclick="signInToGoogle()" style="padding: 8px 12px; background: #4285f4; color: white; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                                üîó Google„Ç´„É¨„É≥„ÉÄ„ÉºÈÄ£Êê∫
                            </button>
                        </div>
                        <div style="font-size: 0.7rem; color: #666; margin-top: 8px; line-height: 1.3;">
                            ‚Äª „Éá„Éº„Çø„ÅØËá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åô
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-title" id="chatTitle">ÈÄ±ÈñìTO DO„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà</div>
                    <div class="chat-subtitle" id="chatSubtitle">Â∑¶„ÅÆ„Ç´„É¨„É≥„ÉÄ„Éº„Åã„ÇâÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <h2>üéØ TO DOÁÆ°ÁêÜ„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ</h2>
                        <p>Â∑¶„ÅÆ„Ç´„É¨„É≥„ÉÄ„Éº„Åã„ÇâÊó•„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ„Åù„ÅÆÊó•„ÅÆ„Çø„Çπ„ÇØ„Å´„Å§„ÅÑ„Å¶ÂØæË©±„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô„ÄÇ</p>
                        <p>„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà„Åå„ÅÇ„Å™„Åü„ÅÆTO DO„ÇíÂäπÁéáÁöÑ„Å´ÁÆ°ÁêÜ„Çí„Çµ„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ</p>
                    </div>
                </div>
                
                <div class="input-container" id="inputContainer" style="display: none;">
                    <input type="text" id="userInput" placeholder="ÂõûÁ≠î„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." 
                           onkeypress="if(event.key==='Enter') handleUserInput()">
                    <button class="send-button" onclick="handleUserInput()">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÈÄ±Èñì„Éá„Éº„Çø„ÅÆÂàùÊúüÂåñ
        let weekData = {
            startDate: new Date(),
            days: [],
            currentDay: null,
            chatHistory: {}
        };
        
        // ÊõúÊó•Âêç
        const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
        
        // „Çµ„É≥„Éó„É´TO DO„Éá„Éº„Çø
        const sampleTodos = {
            0: ['Êúù„ÅÆ„Çπ„Éà„É¨„ÉÉ„ÉÅ', 'ÂÆ∂Êóè„Å®„ÅÆÊôÇÈñì', 'Ë™≠Êõ∏30ÂàÜ'],
            1: ['„É°„Éº„É´Á¢∫Ë™ç', '„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË≥áÊñô‰ΩúÊàê', '„ÉÅ„Éº„É†„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞', 'Êó•Â†±‰ΩúÊàê'],
            2: ['‰ºÅÁîªÊõ∏„É¨„Éì„É•„Éº', '„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÈõªË©±', '„Éá„Éº„ÇøÂàÜÊûê', 'ÈÄ±Ê¨°Â†±ÂëäÊõ∏‰ΩúÊàê'],
            3: ['„Éó„É¨„Çº„É≥Ê∫ñÂÇô', 'Êñ∞‰∫∫Á†î‰øÆ', '„Ç∑„Çπ„ÉÜ„É†Êõ¥Êñ∞Á¢∫Ë™ç'],
            4: ['ÊúàÊ¨°„É¨„Éù„Éº„Éà‰ΩúÊàê', 'Êù•ÈÄ±„ÅÆË®àÁîªÁ´ãÊ°à', '„ÉÅ„Éº„É†ÊááË¶™‰ºö'],
            5: ['ÊéÉÈô§', 'Ë≤∑„ÅÑÁâ©', 'Êò†ÁîªÈëëË≥û', 'Âèã‰∫∫„Å®„ÅÆÂ§ïÈ£ü'],
            6: ['Êï£Ê≠©', 'ÊñôÁêÜ', 'Ê¨°ÈÄ±„ÅÆÊ∫ñÂÇô', 'ÂÆ∂Êóè„Å®„ÅÆÊôÇÈñì']
        };
        
        // „ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà„ÅÆË≥™Âïè„Éë„Çø„Éº„É≥
        const chatPatterns = {
            welcome: {
                message: "„Åì„Çì„Å´„Å°„ÅØÔºÅ{date}„ÅÆTO DO„Å´„Å§„ÅÑ„Å¶„ÅäËÅû„Åç„Åó„Åæ„Åô„ÄÇ‰ªäÊó•„ÅØ{taskCount}ÂÄã„ÅÆ„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô„Å≠„ÄÇ",
                action: "showTasks"
            },
            showTasks: {
                message: "‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ„ÅØ‰ª•‰∏ã„ÅÆÈÄö„Çä„Åß„ÅôÔºö\n{tasks}\n\n„Å©„ÅÆ„Çø„Çπ„ÇØ„Åã„ÇâÂßã„ÇÅ„Åæ„Åô„ÅãÔºü",
                action: "selectTask"
            },
            taskStatus: {
                message: "„Äå{task}„Äç„ÅÆÈÄ≤Êçó„ÅØ„ÅÑ„Åã„Åå„Åß„Åô„ÅãÔºü",
                choices: ["ÂÆå‰∫Ü", "ÈÄ≤Ë°å‰∏≠", "Êú™ÁùÄÊâã", "Ë™≤È°å„ÅÇ„Çä"]
            },
            taskDetails: {
                message: "Ë©≥Á¥∞„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Å©„ÅÆ„Çà„ÅÜ„Å™Áä∂Ê≥Å„Åß„Åô„ÅãÔºü",
                action: "input"
            },
            encouragement: {
                message: "Á¥†Êô¥„Çâ„Åó„ÅÑ„Åß„Åô„Å≠ÔºÅÊ¨°„ÅÆ„Çø„Çπ„ÇØ„Å´ÈÄ≤„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ",
                action: "nextTask"
            },
            support: {
                message: "Ë™≤È°å„Åå„ÅÇ„Çã„Çà„ÅÜ„Åß„Åô„Å≠„ÄÇ„Å©„ÅÆ„Çà„ÅÜ„Å™„Çµ„Éù„Éº„Éà„ÅåÂøÖË¶Å„Åß„Åô„ÅãÔºü",
                choices: ["ÊôÇÈñì„ÅÆË™øÊï¥", "„É™„ÇΩ„Éº„Çπ„ÅÆÁ¢∫‰øù", "ÂÑ™ÂÖàÈ†Ü‰Ωç„ÅÆË¶ãÁõ¥„Åó", "„Åù„ÅÆ‰ªñ"]
            },
            completion: {
                message: "‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ{completed}/{total}ÂÄãÂÆå‰∫Ü„Åß„Åô„ÄÇÊòéÊó•„ÇÇÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ",
                action: "complete"
            }
        };
        
        // ÂàùÊúüÂåñ
        function initializeWeek() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            
            weekData.startDate = monday;
            weekData.days = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                
                weekData.days.push({
                    date: date,
                    dayName: dayNames[date.getDay()],
                    todos: sampleTodos[i] || [],
                    completed: [],
                    inProgress: [],
                    notes: {},
                    isCompleted: false
                });
            }
            
            updateWeekInfo();
            renderCalendar();
            updateSummary();
        }
        
        // ÈÄ±ÊÉÖÂ†±Êõ¥Êñ∞
        function updateWeekInfo() {
            const weekInfo = document.getElementById('weekInfo');
            const year = weekData.startDate.getFullYear();
            const month = weekData.startDate.getMonth() + 1;
            const startDay = weekData.startDate.getDate();
            
            weekInfo.textContent = `${year}Âπ¥ ${month}Êúà Á¨¨${Math.ceil(startDay / 7)}ÈÄ±`;
        }
        
        // „Ç´„É¨„É≥„ÉÄ„ÉºÊèèÁîª
        function renderCalendar() {
            const daysList = document.getElementById('daysList');
            daysList.innerHTML = '';
            
            weekData.days.forEach((day, index) => {
                const dayElement = document.createElement('div');
                dayElement.className = 'day-item';
                dayElement.onclick = () => selectDay(index);
                
                if (weekData.currentDay === index) {
                    dayElement.classList.add('active');
                }
                
                if (day.isCompleted) {
                    dayElement.classList.add('completed');
                }
                
                const completedCount = day.completed.length;
                const totalCount = day.todos.length;
                
                dayElement.innerHTML = `
                    <div class="day-header">${day.dayName}ÊõúÊó•</div>
                    <div class="day-date">${day.date.getMonth() + 1}/${day.date.getDate()}</div>
                    <div class="todo-count">${totalCount}</div>
                    <div class="todo-preview">
                        ${totalCount > 0 ? `${completedCount}/${totalCount} ÂÆå‰∫Ü` : '„Çø„Çπ„ÇØ„Å™„Åó'}
                    </div>
                `;
                
                daysList.appendChild(dayElement);
            });
        }
        
        // Êó•ÈÅ∏Êäû
        function selectDay(dayIndex) {
            weekData.currentDay = dayIndex;
            const selectedDay = weekData.days[dayIndex];
            
            // „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢Êõ¥Êñ∞
            updateChatHeader(selectedDay);
            startDayChat(selectedDay, dayIndex);
            
            // „Ç´„É¨„É≥„ÉÄ„ÉºÊõ¥Êñ∞
            renderCalendar();
            
            // ÂÖ•Âäõ„Ç®„É™„Ç¢Ë°®Á§∫
            document.getElementById('inputContainer').style.display = 'flex';
        }
        
        // „ÉÅ„É£„ÉÉ„Éà„Éò„ÉÉ„ÉÄ„ÉºÊõ¥Êñ∞
        function updateChatHeader(day) {
            const chatTitle = document.getElementById('chatTitle');
            const chatSubtitle = document.getElementById('chatSubtitle');
            
            chatTitle.textContent = `${day.dayName}ÊõúÊó•„ÅÆTO DO`;
            chatSubtitle.textContent = `${day.date.getMonth() + 1}Êúà${day.date.getDate()}Êó• - ${day.todos.length}ÂÄã„ÅÆ„Çø„Çπ„ÇØ`;
        }
        
        // Êó•„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÈñãÂßã
        function startDayChat(day, dayIndex) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // ÂàùÊúüÂåñ„Åæ„Åü„ÅØÂ±•Ê≠¥„ÅÆÂæ©ÂÖÉ
            if (!weekData.chatHistory[dayIndex]) {
                weekData.chatHistory[dayIndex] = {
                    messages: [],
                    currentTask: 0,
                    chatState: 'welcome'
                };
            }
            
            const chatHistory = weekData.chatHistory[dayIndex];
            
            // Â±•Ê≠¥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂæ©ÂÖÉ
            if (chatHistory.messages.length > 0) {
                chatHistory.messages.forEach(message => {
                    addMessage(message.text, message.isUser);
                });
            } else {
                // Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„ÉàÈñãÂßã
                const welcomeMessage = chatPatterns.welcome.message
                    .replace('{date}', `${day.dayName}ÊõúÊó•`)
                    .replace('{taskCount}', day.todos.length);
                
                addMessage(welcomeMessage, false);
                
                if (day.todos.length > 0) {
                    setTimeout(() => {
                        showTasks(day);
                    }, 1000);
                }
            }
        }
        
        // „Çø„Çπ„ÇØË°®Á§∫
        function showTasks(day) {
            const tasksText = day.todos.map((task, index) => `${index + 1}. ${task}`).join('\n');
            const message = chatPatterns.showTasks.message
                .replace('{tasks}', tasksText);
            
            addMessage(message, false);
            
            // „Çø„Çπ„ÇØÈÅ∏ÊäûËÇ¢„ÇíËøΩÂä†
            const choices = day.todos.map((task, index) => ({
                text: `${index + 1}. ${task}`,
                action: () => selectTask(index)
            }));
            
            addChoices(choices);
        }
        
        // „Çø„Çπ„ÇØÈÅ∏Êäû
        function selectTask(taskIndex) {
            const day = weekData.days[weekData.currentDay];
            const task = day.todos[taskIndex];
            const chatHistory = weekData.chatHistory[weekData.currentDay];
            
            chatHistory.currentTask = taskIndex;
            
            addMessage(`„Äå${task}„Äç„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`, true);
            
            setTimeout(() => {
                const message = chatPatterns.taskStatus.message.replace('{task}', task);
                addMessage(message, false);
                
                const choices = chatPatterns.taskStatus.choices.map(choice => ({
                    text: choice,
                    action: () => handleTaskStatus(choice, taskIndex)
                }));
                
                addChoices(choices);
            }, 500);
        }
        
        // „Çø„Çπ„ÇØ„Çπ„ÉÜ„Éº„Çø„ÇπÂá¶ÁêÜ
        function handleTaskStatus(status, taskIndex) {
            const day = weekData.days[weekData.currentDay];
            const task = day.todos[taskIndex];
            
            addMessage(`„Çπ„ÉÜ„Éº„Çø„Çπ: ${status}`, true);
            
            // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Å¶Âá¶ÁêÜ
            switch(status) {
                case 'ÂÆå‰∫Ü':
                    if (!day.completed.includes(taskIndex)) {
                        day.completed.push(taskIndex);
                    }
                    day.inProgress = day.inProgress.filter(i => i !== taskIndex);
                    addMessage(chatPatterns.encouragement.message, false);
                    
                    // „Ç´„É¨„É≥„ÉÄ„Éº„Ç§„Éô„É≥„Éà„ÇíÊõ¥Êñ∞
                    updateTaskInCalendar(weekData.currentDay, taskIndex, true);
                    break;
                    
                case 'ÈÄ≤Ë°å‰∏≠':
                    if (!day.inProgress.includes(taskIndex)) {
                        day.inProgress.push(taskIndex);
                    }
                    addMessage("ÈÄ≤Ë°å‰∏≠„ÅÆ„Çø„Çπ„ÇØ„Åß„Åô„Å≠„ÄÇ‰Ωï„Åã„Çµ„Éù„Éº„Éà„ÅåÂøÖË¶Å„Åß„Åó„Åü„Çâ„ÅäÁü•„Çâ„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ", false);
                    break;
                    
                case 'Êú™ÁùÄÊâã':
                    addMessage("„Åæ„Å†Âßã„ÇÅ„Å¶„ÅÑ„Å™„ÅÑ„Çø„Çπ„ÇØ„Åß„Åô„Å≠„ÄÇ„ÅÑ„Å§È†ÉÈñãÂßã‰∫àÂÆö„Åß„Åô„ÅãÔºü", false);
                    break;
                    
                case 'Ë™≤È°å„ÅÇ„Çä':
                    addMessage(chatPatterns.support.message, false);
                    const supportChoices = chatPatterns.support.choices.map(choice => ({
                        text: choice,
                        action: () => handleSupport(choice, taskIndex)
                    }));
                    addChoices(supportChoices);
                    return;
            }
            
            // „Ç´„É¨„É≥„ÉÄ„ÉºÈÄ£Êê∫„ÅÆÈÅ∏ÊäûËÇ¢„ÇíËøΩÂä†
            setTimeout(() => {
                addCalendarOptions(taskIndex);
            }, 1000);
            
            // Ê¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥
            setTimeout(() => {
                checkDayCompletion();
            }, 2000);
        }
        
        // „Ç´„É¨„É≥„ÉÄ„ÉºÈÄ£Êê∫„Ç™„Éó„Ç∑„Éß„É≥„ÇíË°®Á§∫
        function addCalendarOptions(taskIndex) {
            const choices = [
                {
                    text: 'üìÖ Google„Ç´„É¨„É≥„ÉÄ„Éº„Å´ËøΩÂä†',
                    action: () => addTaskToCalendar(weekData.currentDay, taskIndex)
                },
                {
                    text: 'üìÅ .ics„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ',
                    action: () => generateICSFile(weekData.currentDay, taskIndex)
                },
                {
                    text: '‚è≠Ô∏è Ê¨°„ÅÆ„Çø„Çπ„ÇØ„Å∏',
                    action: () => checkDayCompletion()
                }
            ];
            
            addMessage("„Åì„ÅÆ„Çø„Çπ„ÇØ„Çí„Ç´„É¨„É≥„ÉÄ„Éº„Å´ËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü", false);
            addChoices(choices);
        }
        
        // „Çµ„Éù„Éº„ÉàÂá¶ÁêÜ
        function handleSupport(supportType, taskIndex) {
            addMessage(`„Çµ„Éù„Éº„ÉàÂÜÖÂÆπ: ${supportType}`, true);
            addMessage("ÊâøÁü•„Åó„Åæ„Åó„Åü„ÄÇ„Åù„ÅÆË™≤È°å„Å´„Å§„ÅÑ„Å¶‰∏ÄÁ∑í„Å´ËÄÉ„Åà„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇË©≥Á¥∞„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", false);
        }
        
        // Êó•„ÅÆÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
        function checkDayCompletion() {
            const day = weekData.days[weekData.currentDay];
            const completedCount = day.completed.length;
            const totalCount = day.todos.length;
            
            if (completedCount === totalCount && totalCount > 0) {
                day.isCompleted = true;
                const message = chatPatterns.completion.message
                    .replace('{completed}', completedCount)
                    .replace('{total}', totalCount);
                addMessage(message, false);
            } else {
                // ‰ªñ„ÅÆ„Çø„Çπ„ÇØ„ÇíÁ¢∫Ë™ç
                addMessage("‰ªñ„ÅÆ„Çø„Çπ„ÇØ„ÇÇÁ¢∫Ë™ç„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ", false);
                setTimeout(() => {
                    showRemainingTasks(day);
                }, 1000);
            }
            
            updateSummary();
            renderCalendar();
        }
        
        // ÊÆã„Çä„Çø„Çπ„ÇØË°®Á§∫
        function showRemainingTasks(day) {
            const remainingTasks = day.todos.filter((task, index) => 
                !day.completed.includes(index)
            );
            
            if (remainingTasks.length > 0) {
                const choices = remainingTasks.map((task, index) => {
                    const originalIndex = day.todos.indexOf(task);
                    return {
                        text: task,
                        action: () => selectTask(originalIndex)
                    };
                });
                
                choices.push({
                    text: "‰ªäÊó•„ÅØ„Åì„Åì„Åæ„Åß",
                    action: () => endDayChat()
                });
                
                addChoices(choices);
            }
        }
        
        // Êó•„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÁµÇ‰∫Ü
        function endDayChat() {
            addMessage("‰ªäÊó•„ÅØ„Åì„Åì„Åæ„Åß„Å´„Åó„Åæ„Åô", true);
            addMessage("„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ„Åæ„ÅüÊòéÊó•È†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ", false);
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
        function addMessage(text, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.textContent = text;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Â±•Ê≠¥„Å´‰øùÂ≠ò
            if (weekData.currentDay !== null) {
                weekData.chatHistory[weekData.currentDay].messages.push({
                    text: text,
                    isUser: isUser,
                    timestamp: new Date()
                });
            }
        }
        
        // ÈÅ∏ÊäûËÇ¢ËøΩÂä†
        function addChoices(choices) {
            const chatMessages = document.getElementById('chatMessages');
            const choicesDiv = document.createElement('div');
            choicesDiv.className = 'choices';
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = choice.text;
                button.onclick = () => {
                    choice.action();
                    choicesDiv.style.display = 'none';
                };
                choicesDiv.appendChild(button);
            });
            
            chatMessages.appendChild(choicesDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // „É¶„Éº„Ç∂„ÉºÂÖ•ÂäõÂá¶ÁêÜ
        function handleUserInput() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            
            if (text) {
                addMessage(text, true);
                input.value = '';
                
                // Á∞°Âçò„Å™ÂøúÁ≠î
                setTimeout(() => {
                    addMessage("„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇÊâøÁü•„Åó„Åæ„Åó„Åü„ÄÇ", false);
                }, 500);
            }
        }
        
        // „Çµ„Éû„É™„ÉºÊõ¥Êñ∞
        function updateSummary() {
            const completedDaysCount = weekData.days.filter(day => day.isCompleted).length;
            const totalTasks = weekData.days.reduce((sum, day) => sum + day.todos.length, 0);
            const completedTasks = weekData.days.reduce((sum, day) => sum + day.completed.length, 0);
            const achievementRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('completedDays').textContent = `${completedDaysCount}/7`;
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('achievementRate').textContent = `${achievementRate}%`;
            
            // „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÊõ¥Êñ∞
            document.getElementById('progressFill').style.width = `${achievementRate}%`;
        }
        
        // TO DOÁ∑®ÈõÜÊ©üËÉΩ
        function openTodoEditor() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0;">
                        <h2 style="margin: 0; font-size: 1.5rem;">‚úèÔ∏è ÈÄ±ÈñìTO DOÁ∑®ÈõÜ</h2>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">ÂêÑÊõúÊó•„ÅÆ„Çø„Çπ„ÇØ„ÇíËá™Áî±„Å´Á∑®ÈõÜ„Åß„Åç„Åæ„Åô</p>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div id="todoEditorContent"></div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="this.closest('[style*=fixed]').remove()" 
                                    style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                            <button onclick="saveTodoChanges()" 
                                    style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ‰øùÂ≠ò
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            renderTodoEditor();
            
            // ‰øùÂ≠òÂá¶ÁêÜ
            window.saveTodoChanges = function() {
                saveTodoEditorChanges();
                modal.remove();
                delete window.saveTodoChanges;
            };
        }
        
        // TO DOÁ∑®ÈõÜÁîªÈù¢„ÅÆÊèèÁîª
        function renderTodoEditor() {
            const content = document.getElementById('todoEditorContent');
            content.innerHTML = '';
            
            weekData.days.forEach((day, dayIndex) => {
                const dayEditor = document.createElement('div');
                dayEditor.style.cssText = `
                    margin-bottom: 25px;
                    padding: 20px;
                    border: 2px solid #e9ecef;
                    border-radius: 10px;
                `;
                
                dayEditor.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #333; font-size: 1.2rem;">
                            ${day.dayName}ÊõúÊó• (${day.date.getMonth() + 1}/${day.date.getDate()})
                        </h3>
                        <button onclick="addNewTodo(${dayIndex})" 
                                style="padding: 5px 12px; background: #007bff; color: white; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                            ‚ûï „Çø„Çπ„ÇØËøΩÂä†
                        </button>
                    </div>
                    
                    <div id="todoList-${dayIndex}"></div>
                `;
                
                content.appendChild(dayEditor);
                renderDayTodos(dayIndex);
            });
        }
        
        // ÂêÑÊó•„ÅÆTO DO‰∏ÄË¶ß„ÇíÊèèÁîª
        function renderDayTodos(dayIndex) {
            const todoList = document.getElementById(`todoList-${dayIndex}`);
            const day = weekData.days[dayIndex];
            
            todoList.innerHTML = '';
            
            if (day.todos.length === 0) {
                todoList.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px; border: 2px dashed #ddd; border-radius: 8px;">
                        „Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Äå‚ûï „Çø„Çπ„ÇØËøΩÂä†„Äç„Åß„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    </div>
                `;
                return;
            }
            
            day.todos.forEach((todo, todoIndex) => {
                const todoItem = document.createElement('div');
                todoItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 12px;
                    margin-bottom: 10px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border: 1px solid #e9ecef;
                `;
                
                const isCompleted = day.completed.includes(todoIndex);
                const isInProgress = day.inProgress.includes(todoIndex);
                
                let statusIcon = '‚è∞';
                let statusColor = '#007bff';
                
                if (isCompleted) {
                    statusIcon = '‚úÖ';
                    statusColor = '#28a745';
                } else if (isInProgress) {
                    statusIcon = 'üîÑ';
                    statusColor = '#ffc107';
                }
                
                todoItem.innerHTML = `
                    <span style="font-size: 1.2rem; margin-right: 10px; color: ${statusColor};">${statusIcon}</span>
                    <input type="text" value="${todo}" 
                           onchange="updateTodoText(${dayIndex}, ${todoIndex}, this.value)"
                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-right: 10px;">
                    <button onclick="deleteTodo(${dayIndex}, ${todoIndex})" 
                            style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                        üóëÔ∏è
                    </button>
                `;
                
                todoList.appendChild(todoItem);
            });
        }
        
        // Êñ∞„Åó„ÅÑTO DOËøΩÂä†
        window.addNewTodo = function(dayIndex) {
            const todoText = prompt('Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (todoText && todoText.trim()) {
                weekData.days[dayIndex].todos.push(todoText.trim());
                renderDayTodos(dayIndex);
            }
        };
        
        // TO DO„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
        window.updateTodoText = function(dayIndex, todoIndex, newText) {
            if (newText.trim()) {
                weekData.days[dayIndex].todos[todoIndex] = newText.trim();
            }
        };
        
        // TO DOÂâäÈô§
        window.deleteTodo = function(dayIndex, todoIndex) {
            if (confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const day = weekData.days[dayIndex];
                
                // Èñ¢ÈÄ£„Éá„Éº„Çø„ÇÇÂâäÈô§
                day.todos.splice(todoIndex, 1);
                day.completed = day.completed.filter(i => i !== todoIndex).map(i => i > todoIndex ? i - 1 : i);
                day.inProgress = day.inProgress.filter(i => i !== todoIndex).map(i => i > todoIndex ? i - 1 : i);
                
                renderDayTodos(dayIndex);
            }
        };
        
        // TO DOÁ∑®ÈõÜÂÜÖÂÆπ„Çí‰øùÂ≠ò
        function saveTodoEditorChanges() {
            // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí„ÇØ„É™„Ç¢Ôºà„Çø„Çπ„ÇØ„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Åü„ÇÅÔºâ
            weekData.chatHistory = {};
            
            // UIÊõ¥Êñ∞
            renderCalendar();
            updateSummary();
            
            // „Éá„Éº„Çø‰øùÂ≠ò
            saveData();
            
            // „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢„Çí„É™„Çª„ÉÉ„Éà
            if (weekData.currentDay !== null) {
                const selectedDay = weekData.days[weekData.currentDay];
                updateChatHeader(selectedDay);
                startDayChat(selectedDay, weekData.currentDay);
            }
            
            alert('‚úÖ TO DO„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
        }
        
        // ÂàùÊúü„Éá„Éº„Çø„Çí„Çµ„É≥„Éó„É´„Åã„ÇâÂÆüÈöõ„ÅÆ„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Å´Â§âÊõ¥
        function initializeWeek() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            
            weekData.startDate = monday;
            weekData.days = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                
                weekData.days.push({
                    date: date,
                    dayName: dayNames[date.getDay()],
                    todos: [], // Á©∫„ÅÆ„Çø„Çπ„ÇØ„É™„Çπ„Éà„ÅßÈñãÂßã
                    completed: [],
                    inProgress: [],
                    notes: {},
                    isCompleted: false
                });
            }
            
            updateWeekInfo();
            renderCalendar();
            updateSummary();
        }
        
        // „Çµ„É≥„Éó„É´„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÊ©üËÉΩ
        function loadSampleData() {
            if (confirm('„Çµ„É≥„Éó„É´„ÅÆTO DO„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü\nÔºàÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„ÅôÔºâ')) {
                weekData.days.forEach((day, index) => {
                    day.todos = sampleTodos[index] || [];
                    day.completed = [];
                    day.inProgress = [];
                    day.isCompleted = false;
                });
                
                weekData.chatHistory = {};
                
                renderCalendar();
                updateSummary();
                saveData();
                
                alert('‚úÖ „Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ');
            }
        }
        let gapi_loaded = false;
        let calendar_api_ready = false;
        
        // Google Calendar APIÂàùÊúüÂåñ
        function initializeGoogleCalendar() {
            gapi.load('client:auth2', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: 'YOUR_API_KEY', // Google Cloud Console„ÅßÂèñÂæó
                    clientId: 'YOUR_CLIENT_ID', // Google Cloud Console„ÅßÂèñÂæó
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
                    scope: 'https://www.googleapis.com/auth/calendar'
                });
                
                calendar_api_ready = true;
                console.log('‚úÖ Google Calendar APIÂàùÊúüÂåñÂÆå‰∫Ü');
                
                // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                updateCalendarButtons();
            } catch (error) {
                console.error('‚ùå Google Calendar APIÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }
        
        // Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥
        async function signInToGoogle() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signIn();
                console.log('‚úÖ Google„É≠„Ç∞„Ç§„É≥ÊàêÂäü');
                updateCalendarButtons();
                return true;
            } catch (error) {
                console.error('‚ùå Google„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                return false;
            }
        }
        
        // „Ç´„É¨„É≥„ÉÄ„Éº„Å´„Çø„Çπ„ÇØ„ÇíËøΩÂä†
        async function addTaskToCalendar(dayIndex, taskIndex) {
            if (!calendar_api_ready) {
                alert('Google Calendar API„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            const authInstance = gapi.auth2.getAuthInstance();
            if (!authInstance.isSignedIn.get()) {
                const success = await signInToGoogle();
                if (!success) return;
            }
            
            const day = weekData.days[dayIndex];
            const task = day.todos[taskIndex];
            
            // „Ç§„Éô„É≥„Éà„ÅÆÈñãÂßãÊôÇÈñìÔºà„Åù„ÅÆÊó•„ÅÆ9:00„Å´Ë®≠ÂÆöÔºâ
            const startTime = new Date(day.date);
            startTime.setHours(9, 0, 0, 0);
            
            // „Ç§„Éô„É≥„Éà„ÅÆÁµÇ‰∫ÜÊôÇÈñìÔºà1ÊôÇÈñìÂæåÔºâ
            const endTime = new Date(startTime);
            endTime.setHours(10, 0, 0, 0);
            
            const event = {
                'summary': `üìã TODO: ${task}`,
                'description': `TO DO„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà„Åã„ÇâËøΩÂä†„Åï„Çå„Åü„Çø„Çπ„ÇØ\n\nË©≥Á¥∞:\n- Êó•‰ªò: ${day.dayName}ÊõúÊó•\n- „Çø„Çπ„ÇØ: ${task}\n- ËøΩÂä†Êó•ÊôÇ: ${new Date().toLocaleString()}`,
                'start': {
                    'dateTime': startTime.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'end': {
                    'dateTime': endTime.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'reminders': {
                    'useDefault': false,
                    'overrides': [
                        {'method': 'popup', 'minutes': 30}
                    ]
                }
            };
            
            try {
                const response = await gapi.client.calendar.events.insert({
                    'calendarId': 'primary',
                    'resource': event
                });
                
                console.log('‚úÖ „Ç´„É¨„É≥„ÉÄ„Éº„Ç§„Éô„É≥„Éà‰ΩúÊàêÊàêÂäü:', response);
                alert(`‚úÖ "${task}" „ÇíGoogle„Ç´„É¨„É≥„ÉÄ„Éº„Å´ËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ`);
                
                // „Çø„Çπ„ÇØ„Å´„Ç´„É¨„É≥„ÉÄ„Éº„Ç§„Éô„É≥„ÉàID„Çí‰øùÂ≠ò
                if (!day.calendarEvents) day.calendarEvents = {};
                day.calendarEvents[taskIndex] = response.result.id;
                saveData();
                
            } catch (error) {
                console.error('‚ùå „Ç´„É¨„É≥„ÉÄ„Éº„Ç§„Éô„É≥„Éà‰ΩúÊàê„Ç®„É©„Éº:', error);
                alert('‚ùå „Ç´„É¨„É≥„ÉÄ„Éº„Å∏„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // ÂÆå‰∫Ü„Åó„Åü„Çø„Çπ„ÇØ„Çí„Ç´„É¨„É≥„ÉÄ„Éº„ÅßÊõ¥Êñ∞
        async function updateTaskInCalendar(dayIndex, taskIndex, isCompleted) {
            const day = weekData.days[dayIndex];
            const task = day.todos[taskIndex];
            
            if (!day.calendarEvents || !day.calendarEvents[taskIndex]) {
                return; // „Ç´„É¨„É≥„ÉÄ„Éº„Ç§„Éô„É≥„Éà„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ
            }
            
            const eventId = day.calendarEvents[taskIndex];
            
            try {
                // „Ç§„Éô„É≥„Éà„ÇíÂèñÂæó
                const event = await gapi.client.calendar.events.get({
                    'calendarId': 'primary',
                    'eventId': eventId
                });
                
                // „Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞ÔºàÂÆå‰∫Ü„Éû„Éº„ÇØ„Çí‰ªò„Åë„ÇãÔºâ
                const summary = isCompleted 
                    ? `‚úÖ TODOÂÆå‰∫Ü: ${task}`
                    : `üìã TODO: ${task}`;
                
                // „Ç§„Éô„É≥„Éà„ÇíÊõ¥Êñ∞
                await gapi.client.calendar.events.update({
                    'calendarId': 'primary',
                    'eventId': eventId,
                    'resource': {
                        ...event.result,
                        'summary': summary
                    }
                });
                
                console.log('‚úÖ „Ç´„É¨„É≥„ÉÄ„Éº„Ç§„Éô„É≥„ÉàÊõ¥Êñ∞ÊàêÂäü');
                
            } catch (error) {
                console.error('‚ùå „Ç´„É¨„É≥„ÉÄ„Éº„Ç§„Éô„É≥„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', error);
            }
        }
        
        // „Ç´„É¨„É≥„ÉÄ„Éº„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateCalendarButtons() {
            const calendarButtons = document.querySelectorAll('.calendar-sync-btn');
            const isSignedIn = calendar_api_ready && 
                              gapi.auth2 && 
                              gapi.auth2.getAuthInstance() && 
                              gapi.auth2.getAuthInstance().isSignedIn.get();
            
            calendarButtons.forEach(btn => {
                btn.disabled = !isSignedIn;
                btn.textContent = isSignedIn ? 'üìÖ „Ç´„É¨„É≥„ÉÄ„Éº„Å´ËøΩÂä†' : 'üîí „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å';
            });
        }
        
        // .ics„Éï„Ç°„Ç§„É´ÁîüÊàêÔºàOutlookÊúÄÈÅ©ÂåñÁâàÔºâ
        function generateICSFile(dayIndex, taskIndex) {
            const day = weekData.days[dayIndex];
            const task = day.todos[taskIndex];
            
            // „Çø„Çπ„ÇØ„ÅÆÊôÇÈñìË®≠ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
            showTimeSettingDialog(day, task, (startTime, duration, reminder) => {
                createICSFile(day, task, startTime, duration, reminder, dayIndex, taskIndex);
            });
        }
        
        // ÊôÇÈñìË®≠ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞
        function showTimeSettingDialog(day, task, callback) {
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            dialog.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%;">
                    <h3 style="margin-bottom: 20px; color: #333;">üìÖ „Ç´„É¨„É≥„ÉÄ„ÉºË®≠ÂÆö</h3>
                    <p style="margin-bottom: 15px; color: #666;">„Çø„Çπ„ÇØ: ${task}</p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÈñãÂßãÊôÇÈñì:</label>
                        <input type="time" id="taskTime" value="09:00" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÊâÄË¶ÅÊôÇÈñì:</label>
                        <select id="taskDuration" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="30">30ÂàÜ</option>
                            <option value="60" selected>1ÊôÇÈñì</option>
                            <option value="90">1ÊôÇÈñì30ÂàÜ</option>
                            <option value="120">2ÊôÇÈñì</option>
                            <option value="180">3ÊôÇÈñì</option>
                            <option value="240">4ÊôÇÈñì</option>
                            <option value="480">ÁµÇÊó•Ôºà8ÊôÇÈñìÔºâ</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">„É™„Éû„Ç§„É≥„ÉÄ„Éº:</label>
                        <select id="taskReminder" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="0">„Å™„Åó</option>
                            <option value="15">15ÂàÜÂâç</option>
                            <option value="30" selected>30ÂàÜÂâç</option>
                            <option value="60">1ÊôÇÈñìÂâç</option>
                            <option value="120">2ÊôÇÈñìÂâç</option>
                            <option value="1440">1Êó•Ââç</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="this.closest('[style*=fixed]').remove()" 
                                style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button onclick="confirmTimeSettings()" 
                                style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            „Ç´„É¨„É≥„ÉÄ„Éº„Å´ËøΩÂä†
                        </button>
                    </div>
                </div>
            `;
            
            // Á¢∫Ë™ç„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
            window.confirmTimeSettings = function() {
                const time = document.getElementById('taskTime').value;
                const duration = parseInt(document.getElementById('taskDuration').value);
                const reminder = parseInt(document.getElementById('taskReminder').value);
                
                dialog.remove();
                callback(time, duration, reminder);
                delete window.confirmTimeSettings;
            };
            
            document.body.appendChild(dialog);
        }
        
        // ÂÆüÈöõ„ÅÆ.ics„Éï„Ç°„Ç§„É´‰ΩúÊàê
        function createICSFile(day, task, startTime, duration, reminder, dayIndex, taskIndex) {
            // ÈñãÂßãÊôÇÈñì„ÇíË®≠ÂÆö
            const [hours, minutes] = startTime.split(':');
            const startDate = new Date(day.date);
            startDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            // ÁµÇ‰∫ÜÊôÇÈñì„ÇíË®àÁÆó
            const endDate = new Date(startDate);
            endDate.setMinutes(endDate.getMinutes() + duration);
            
            // ICSÂΩ¢Âºè„ÅÆÊó•ÊôÇ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàOutlookÂØæÂøúÔºâ
            function formatICSDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hour = String(date.getHours()).padStart(2, '0');
                const min = String(date.getMinutes()).padStart(2, '0');
                const sec = String(date.getSeconds()).padStart(2, '0');
                
                return `${year}${month}${day}T${hour}${min}${sec}`;
            }
            
            // „Çø„Çπ„ÇØ„ÅÆÈÄ≤ÊçóÁä∂Ê≥Å„ÇíÂèñÂæó
            const dayData = weekData.days[dayIndex];
            const isCompleted = dayData.completed.includes(taskIndex);
            const isInProgress = dayData.inProgress.includes(taskIndex);
            
            let status = '‚è∞ TODO';
            let priority = 'NORMAL';
            
            if (isCompleted) {
                status = '‚úÖ ÂÆå‰∫Ü';
                priority = 'LOW';
            } else if (isInProgress) {
                status = 'üîÑ ÈÄ≤Ë°å‰∏≠';
                priority = 'HIGH';
            }
            
            // „Ç´„ÉÜ„Ç¥„É™Ë®≠ÂÆöÔºàOutlook„Åß„ÅÆËâ≤ÂàÜ„ÅëÔºâ
            const category = isCompleted ? 'GREEN' : isInProgress ? 'YELLOW' : 'BLUE';
            
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//TO DO„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà//NONSGML v1.0//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:todo-${dayIndex}-${taskIndex}-${Date.now()}@todoapp.local
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(startDate)}
DTEND:${formatICSDate(endDate)}
SUMMARY:${status}: ${task}
DESCRIPTION:üìã TO DO„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà„Åã„ÇâËøΩÂä†„Åï„Çå„Åü„Çø„Çπ„ÇØ\\n\\nüìÖ Êó•‰ªò: ${day.dayName}ÊõúÊó• (${day.date.getMonth() + 1}/${day.date.getDate()})\\nüìù „Çø„Çπ„ÇØ: ${task}\\n‚è∞ ÊâÄË¶ÅÊôÇÈñì: ${duration}ÂàÜ\\nüìä „Çπ„ÉÜ„Éº„Çø„Çπ: ${status}\\n\\nü§ñ TO DO„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà„ÅßÁÆ°ÁêÜ‰∏≠
LOCATION:
PRIORITY:${priority}
STATUS:${isCompleted ? 'COMPLETED' : 'CONFIRMED'}
SEQUENCE:0
CATEGORIES:TODO,${category}
TRANSP:OPAQUE`;

            // „É™„Éû„Ç§„É≥„ÉÄ„Éº„ÅÆËøΩÂä†
            if (reminder > 0) {
                icsContent += `
BEGIN:VALARM
TRIGGER:-PT${reminder}M
DESCRIPTION:üìã „Çø„Çπ„ÇØ„ÅÆ„É™„Éû„Ç§„É≥„ÉÄ„Éº: ${task}
ACTION:DISPLAY
END:VALARM`;
            }

            icsContent += `
END:VEVENT
END:VCALENDAR`;
            
            // „Éï„Ç°„Ç§„É´Âêç„ÇíÊó•Êú¨Ë™ûÂØæÂøú„ÅßÁîüÊàê
            const fileName = `TODO_${day.dayName}_${task.substring(0, 10).replace(/[^\w\s]/gi, '')}_${startTime.replace(':', '')}.ics`;
            
            // „Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
            setTimeout(() => {
                addMessage(`‚úÖ "${task}" „ÅÆ„Ç´„É¨„É≥„ÉÄ„Éº„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ`, false);
                addMessage(`üìÅ „Éï„Ç°„Ç§„É´Âêç: ${fileName}`, false);
                addMessage(`üí° „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åü„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Outlook„ÅßÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`, false);
            }, 500);
        }
        const STORAGE_KEY = 'weekly_todo_data';
        
        // „Éá„Éº„Çø„Çí‰øùÂ≠ò
        function saveData() {
            try {
                const dataToSave = {
                    weekData: weekData,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('‚úÖ „Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                return true;
            } catch (error) {
                console.error('‚ùå ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                return false;
            }
        }
        
        // „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    
                    // Êó•‰ªò„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂæ©ÂÖÉ
                    if (parsed.weekData && parsed.weekData.days) {
                        parsed.weekData.days.forEach(day => {
                            day.date = new Date(day.date);
                        });
                        parsed.weekData.startDate = new Date(parsed.weekData.startDate);
                    }
                    
                    weekData = {...weekData, ...parsed.weekData};
                    console.log('‚úÖ „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
            return false;
        }
        
        // „Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
        function clearData() {
            if (confirm('‰øùÂ≠ò„Åï„Çå„Åü„Éá„Éº„Çø„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        // JSON„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportData() {
            const dataToExport = {
                weekData: weekData,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `todo_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„Ç§„É≥„Éù„Éº„Éà
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (imported.weekData) {
                        // Êó•‰ªò„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂæ©ÂÖÉ
                        imported.weekData.days.forEach(day => {
                            day.date = new Date(day.date);
                        });
                        imported.weekData.startDate = new Date(imported.weekData.startDate);
                        
                        weekData = imported.weekData;
                        saveData();
                        
                        // UIÊõ¥Êñ∞
                        updateWeekInfo();
                        renderCalendar();
                        updateSummary();
                        
                        alert('‚úÖ „Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ');
                    }
                } catch (error) {
                    alert('‚ùå „Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Ëá™Âãï‰øùÂ≠ò„ÇíÊúâÂäπÂåñÔºà„Éá„Éº„ÇøÂ§âÊõ¥ÊôÇ„Å´Ëá™ÂãïÂÆüË°åÔºâ
        function enableAutoSave() {
            // „Éá„Éº„Çø„ÅåÂ§âÊõ¥„Åï„Çå„Çã„Åü„Å≥„Å´Ëá™Âãï‰øùÂ≠ò
            const originalSelectDay = selectDay;
            selectDay = function(dayIndex) {
                originalSelectDay(dayIndex);
                saveData();
            };
            
            const originalHandleTaskStatus = handleTaskStatus;
            handleTaskStatus = function(status, taskIndex) {
                originalHandleTaskStatus(status, taskIndex);
                saveData();
            };
        }
        
        // ÂàùÊúüÂåñÂÆüË°å
        document.addEventListener('DOMContentLoaded', function() {
            // „Åæ„Åö‰øùÂ≠ò„Åï„Çå„Åü„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            const hasData = loadData();
            
            // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶è‰ΩúÊàê
            if (!hasData) {
                initializeWeek();
            } else {
                // Êó¢Â≠ò„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØUIÊõ¥Êñ∞
                updateWeekInfo();
                renderCalendar();
                updateSummary();
            }
            
            // Ëá™Âãï‰øùÂ≠ò„ÇíÊúâÂäπÂåñ
            enableAutoSave();
        });
    </script>
</body>
</html>