<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€±é–“TO DOã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .calendar-container {
            background: white;
            border-radius: 20px;
            max-width: 1200px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .week-info {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .calendar-sidebar {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            padding: 20px;
        }
        
        .week-calendar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .week-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .day-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .day-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .day-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .day-item.completed {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .day-item.active.completed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .day-header {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .day-date {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        .todo-count {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .day-item.completed .todo-count {
            background: #28a745;
        }
        
        .todo-preview {
            font-size: 0.8rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }
        
        .chat-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .chat-subtitle {
            font-size: 0.9rem;
            color: #666;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .bot-message {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-left: auto;
            max-width: 70%;
            text-align: right;
        }
        
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .input-container input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.3s;
            font-size: 1rem;
        }
        
        .input-container input:focus {
            border-color: #667eea;
        }
        
        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-button:hover {
            transform: scale(1.1);
        }
        
        .choices {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .choice-button {
            background: #e9ecef;
            border: 2px solid #e9ecef;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .choice-button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .summary-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .summary-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .summary-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
        }
        
        .welcome-message {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        
        .welcome-message h2 {
            color: #333;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .calendar-sidebar {
                width: 100%;
                height: 300px;
            }
            
            .calendar-container {
                height: 100vh;
            }
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <div class="header">
            <div class="week-info" id="weekInfo">2024å¹´ ç¬¬1é€±</div>
            <h1>ğŸ“… é€±é–“TO DOãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</h1>
            <p>æ¯æ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’å¯¾è©±å½¢å¼ã§ç®¡ç†ã—ã¾ã—ã‚‡ã†</p>
        </div>

    <!-- Google Calendar APIèª­ã¿è¾¼ã¿ -->
    <script src="https://apis.google.com/js/api.js" onload="initializeGoogleCalendar()"></script>
        
        <div class="main-content">
            <div class="calendar-sidebar">
                <div class="week-calendar">
                    <div class="week-header">ä»Šé€±ã®TO DO</div>
                    <div id="daysList"></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    
                    <!-- TO DOç·¨é›†ãƒœã‚¿ãƒ³ -->
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="openTodoEditor()" style="padding: 10px 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; width: 100%;">
                            âœï¸ TO DOã‚’ç·¨é›†
                        </button>
                    </div>
                </div>
                
                <div class="summary-panel">
                    <div class="summary-title">ğŸ“Š é€±é–“ã‚µãƒãƒªãƒ¼</div>
                    <div class="summary-stat">
                        <span class="stat-label">å®Œäº†ã—ãŸæ—¥:</span>
                        <span class="stat-value" id="completedDays">0/7</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">ç·ã‚¿ã‚¹ã‚¯æ•°:</span>
                        <span class="stat-value" id="totalTasks">0</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">å®Œäº†ã‚¿ã‚¹ã‚¯:</span>
                        <span class="stat-value" id="completedTasks">0</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">é”æˆç‡:</span>
                        <span class="stat-value" id="achievementRate">0%</span>
                    </div>
                    
                    <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒœã‚¿ãƒ³ -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                        <div style="font-size: 0.9rem; font-weight: bold; margin-bottom: 10px; color: #333;">
                            ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button onclick="exportData()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                                ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                            <label style="padding: 8px 12px; background: #007bff; color: white; border-radius: 5px; font-size: 0.8rem; cursor: pointer; text-align: center;">
                                ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                                <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                            </label>
                            <button onclick="clearData()" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                                ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                            </button>
                            <button onclick="signInToGoogle()" style="padding: 8px 12px; background: #4285f4; color: white; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                                ğŸ”— Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº
                            </button>
                        </div>
                        <div style="font-size: 0.7rem; color: #666; margin-top: 8px; line-height: 1.3;">
                            â€» ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-title" id="chatTitle">é€±é–“TO DOãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</div>
                    <div class="chat-subtitle" id="chatSubtitle">å·¦ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <h2>ğŸ¯ TO DOç®¡ç†ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</h2>
                        <p>å·¦ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®æ—¥ã®ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦å¯¾è©±ã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>
                        <p>ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆãŒã‚ãªãŸã®TO DOã‚’åŠ¹ç‡çš„ã«ç®¡ç†ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
                    </div>
                </div>
                
                <div class="input-container" id="inputContainer" style="display: none;">
                    <input type="text" id="userInput" placeholder="å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." 
                           onkeypress="if(event.key==='Enter') handleUserInput()">
                    <button class="send-button" onclick="handleUserInput()">
                        â¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é€±é–“ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
        let weekData = {
            startDate: new Date(),
            days: [],
            currentDay: null,
            chatHistory: {}
        };
        
        // æ›œæ—¥å
        const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        
        // ã‚µãƒ³ãƒ—ãƒ«TO DOãƒ‡ãƒ¼ã‚¿
        const sampleTodos = {
            0: ['æœã®ã‚¹ãƒˆãƒ¬ãƒƒãƒ', 'å®¶æ—ã¨ã®æ™‚é–“', 'èª­æ›¸30åˆ†'],
            1: ['ãƒ¡ãƒ¼ãƒ«ç¢ºèª', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè³‡æ–™ä½œæˆ', 'ãƒãƒ¼ãƒ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°', 'æ—¥å ±ä½œæˆ'],
            2: ['ä¼ç”»æ›¸ãƒ¬ãƒ“ãƒ¥ãƒ¼', 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé›»è©±', 'ãƒ‡ãƒ¼ã‚¿åˆ†æ', 'é€±æ¬¡å ±å‘Šæ›¸ä½œæˆ'],
            3: ['ãƒ—ãƒ¬ã‚¼ãƒ³æº–å‚™', 'æ–°äººç ”ä¿®', 'ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°ç¢ºèª'],
            4: ['æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ', 'æ¥é€±ã®è¨ˆç”»ç«‹æ¡ˆ', 'ãƒãƒ¼ãƒ æ‡‡è¦ªä¼š'],
            5: ['æƒé™¤', 'è²·ã„ç‰©', 'æ˜ ç”»é‘‘è³', 'å‹äººã¨ã®å¤•é£Ÿ'],
            6: ['æ•£æ­©', 'æ–™ç†', 'æ¬¡é€±ã®æº–å‚™', 'å®¶æ—ã¨ã®æ™‚é–“']
        };
        
        // ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®è³ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³
        const chatPatterns = {
            welcome: {
                message: "ã“ã‚“ã«ã¡ã¯ï¼{date}ã®TO DOã«ã¤ã„ã¦ãŠèãã—ã¾ã™ã€‚ä»Šæ—¥ã¯{taskCount}å€‹ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã­ã€‚",
                action: "showTasks"
            },
            showTasks: {
                message: "ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š\n{tasks}\n\nã©ã®ã‚¿ã‚¹ã‚¯ã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ",
                action: "selectTask"
            },
            taskStatus: {
                message: "ã€Œ{task}ã€ã®é€²æ—ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿ",
                choices: ["å®Œäº†", "é€²è¡Œä¸­", "æœªç€æ‰‹", "èª²é¡Œã‚ã‚Š"]
            },
            taskDetails: {
                message: "è©³ç´°ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚ã©ã®ã‚ˆã†ãªçŠ¶æ³ã§ã™ã‹ï¼Ÿ",
                action: "input"
            },
            encouragement: {
                message: "ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ï¼æ¬¡ã®ã‚¿ã‚¹ã‚¯ã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚",
                action: "nextTask"
            },
            support: {
                message: "èª²é¡ŒãŒã‚ã‚‹ã‚ˆã†ã§ã™ã­ã€‚ã©ã®ã‚ˆã†ãªã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ã§ã™ã‹ï¼Ÿ",
                choices: ["æ™‚é–“ã®èª¿æ•´", "ãƒªã‚½ãƒ¼ã‚¹ã®ç¢ºä¿", "å„ªå…ˆé †ä½ã®è¦‹ç›´ã—", "ãã®ä»–"]
            },
            completion: {
                message: "ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼{completed}/{total}å€‹å®Œäº†ã§ã™ã€‚æ˜æ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼",
                action: "complete"
            }
        };
        
        // åˆæœŸåŒ–
        function initializeWeek() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            
            weekData.startDate = monday;
            weekData.days = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                
                weekData.days.push({
                    date: date,
                    dayName: dayNames[date.getDay()],
                    todos: sampleTodos[i] || [],
                    completed: [],
                    inProgress: [],
                    notes: {},
                    isCompleted: false
                });
            }
            
            updateWeekInfo();
            renderCalendar();
            updateSummary();
        }
        
        // é€±æƒ…å ±æ›´æ–°
        function updateWeekInfo() {
            const weekInfo = document.getElementById('weekInfo');
            const year = weekData.startDate.getFullYear();
            const month = weekData.startDate.getMonth() + 1;
            const startDay = weekData.startDate.getDate();
            
            weekInfo.textContent = `${year}å¹´ ${month}æœˆ ç¬¬${Math.ceil(startDay / 7)}é€±`;
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderCalendar() {
            const daysList = document.getElementById('daysList');
            daysList.innerHTML = '';
            
            weekData.days.forEach((day, index) => {
                const dayElement = document.createElement('div');
                dayElement.className = 'day-item';
                dayElement.onclick = () => selectDay(index);
                
                if (weekData.currentDay === index) {
                    dayElement.classList.add('active');
                }
                
                if (day.isCompleted) {
                    dayElement.classList.add('completed');
                }
                
                const completedCount = day.completed.length;
                const totalCount = day.todos.length;
                
                dayElement.innerHTML = `
                    <div class="day-header">${day.dayName}æ›œæ—¥</div>
                    <div class="day-date">${day.date.getMonth() + 1}/${day.date.getDate()}</div>
                    <div class="todo-count">${totalCount}</div>
                    <div class="todo-preview">
                        ${totalCount > 0 ? `${completedCount}/${totalCount} å®Œäº†` : 'ã‚¿ã‚¹ã‚¯ãªã—'}
                    </div>
                `;
                
                daysList.appendChild(dayElement);
            });
        }
        
        // æ—¥é¸æŠ
        function selectDay(dayIndex) {
            weekData.currentDay = dayIndex;
            const selectedDay = weekData.days[dayIndex];
            
            // ãƒãƒ£ãƒƒãƒˆç”»é¢æ›´æ–°
            updateChatHeader(selectedDay);
            startDayChat(selectedDay, dayIndex);
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°
            renderCalendar();
            
            // å…¥åŠ›ã‚¨ãƒªã‚¢è¡¨ç¤º
            document.getElementById('inputContainer').style.display = 'flex';
        }
        
        // ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
        function updateChatHeader(day) {
            const chatTitle = document.getElementById('chatTitle');
            const chatSubtitle = document.getElementById('chatSubtitle');
            
            chatTitle.textContent = `${day.dayName}æ›œæ—¥ã®TO DO`;
            chatSubtitle.textContent = `${day.date.getMonth() + 1}æœˆ${day.date.getDate()}æ—¥ - ${day.todos.length}å€‹ã®ã‚¿ã‚¹ã‚¯`;
        }
        
        // æ—¥ã®ãƒãƒ£ãƒƒãƒˆé–‹å§‹
        function startDayChat(day, dayIndex) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // åˆæœŸåŒ–ã¾ãŸã¯å±¥æ­´ã®å¾©å…ƒ
            if (!weekData.chatHistory[dayIndex]) {
                weekData.chatHistory[dayIndex] = {
                    messages: [],
                    currentTask: 0,
                    chatState: 'welcome'
                };
            }
            
            const chatHistory = weekData.chatHistory[dayIndex];
            
            // å±¥æ­´ãŒã‚ã‚‹å ´åˆã¯å¾©å…ƒ
            if (chatHistory.messages.length > 0) {
                chatHistory.messages.forEach(message => {
                    addMessage(message.text, message.isUser);
                });
            } else {
                // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆé–‹å§‹
                const welcomeMessage = chatPatterns.welcome.message
                    .replace('{date}', `${day.dayName}æ›œæ—¥`)
                    .replace('{taskCount}', day.todos.length);
                
                addMessage(welcomeMessage, false);
                
                if (day.todos.length > 0) {
                    setTimeout(() => {
                        showTasks(day);
                    }, 1000);
                }
            }
        }
        
        // ã‚¿ã‚¹ã‚¯è¡¨ç¤º
        function showTasks(day) {
            const tasksText = day.todos.map((task, index) => `${index + 1}. ${task}`).join('\n');
            const message = chatPatterns.showTasks.message
                .replace('{tasks}', tasksText);
            
            addMessage(message, false);
            
            // ã‚¿ã‚¹ã‚¯é¸æŠè‚¢ã‚’è¿½åŠ 
            const choices = day.todos.map((task, index) => ({
                text: `${index + 1}. ${task}`,
                action: () => selectTask(index)
            }));
            
            addChoices(choices);
        }
        
        // ã‚¿ã‚¹ã‚¯é¸æŠ
        function selectTask(taskIndex) {
            const day = weekData.days[weekData.currentDay];
            const task = day.todos[taskIndex];
            const chatHistory = weekData.chatHistory[weekData.currentDay];
            
            chatHistory.currentTask = taskIndex;
            
            addMessage(`ã€Œ${task}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`, true);
            
            setTimeout(() => {
                const message = chatPatterns.taskStatus.message.replace('{task}', task);
                addMessage(message, false);
                
                const choices = chatPatterns.taskStatus.choices.map(choice => ({
                    text: choice,
                    action: () => handleTaskStatus(choice, taskIndex)
                }));
                
                addChoices(choices);
            }, 500);
        }
        
        // ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡¦ç†
        function handleTaskStatus(status, taskIndex) {
            const day = weekData.days[weekData.currentDay];
            const task = day.todos[taskIndex];
            
            addMessage(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${status}`, true);
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦å‡¦ç†
            switch(status) {
                case 'å®Œäº†':
                    if (!day.completed.includes(taskIndex)) {
                        day.completed.push(taskIndex);
                    }
                    day.inProgress = day.inProgress.filter(i => i !== taskIndex);
                    addMessage(chatPatterns.encouragement.message, false);
                    
                    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°
                    updateTaskInCalendar(weekData.currentDay, taskIndex, true);
                    break;
                    
                case 'é€²è¡Œä¸­':
                    if (!day.inProgress.includes(taskIndex)) {
                        day.inProgress.push(taskIndex);
                    }
                    addMessage("é€²è¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã§ã™ã­ã€‚ä½•ã‹ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ã§ã—ãŸã‚‰ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚", false);
                    break;
                    
                case 'æœªç€æ‰‹':
                    addMessage("ã¾ã å§‹ã‚ã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã§ã™ã­ã€‚ã„ã¤é ƒé–‹å§‹äºˆå®šã§ã™ã‹ï¼Ÿ", false);
                    break;
                    
                case 'èª²é¡Œã‚ã‚Š':
                    addMessage(chatPatterns.support.message, false);
                    const supportChoices = chatPatterns.support.choices.map(choice => ({
                        text: choice,
                        action: () => handleSupport(choice, taskIndex)
                    }));
                    addChoices(supportChoices);
                    return;
            }
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºã®é¸æŠè‚¢ã‚’è¿½åŠ 
            setTimeout(() => {
                addCalendarOptions(taskIndex);
            }, 1000);
            
            // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            setTimeout(() => {
                checkDayCompletion();
            }, 2000);
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        function addCalendarOptions(taskIndex) {
            const choices = [
                {
                    text: 'ğŸ“… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ',
                    action: () => addTaskToCalendar(weekData.currentDay, taskIndex)
                },
                {
                    text: 'ğŸ“ .icsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
                    action: () => generateICSFile(weekData.currentDay, taskIndex)
                },
                {
                    text: 'â­ï¸ æ¬¡ã®ã‚¿ã‚¹ã‚¯ã¸',
                    action: () => checkDayCompletion()
                }
            ];
            
            addMessage("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ", false);
            addChoices(choices);
        }
        
        // ã‚µãƒãƒ¼ãƒˆå‡¦ç†
        function handleSupport(supportType, taskIndex) {
            addMessage(`ã‚µãƒãƒ¼ãƒˆå†…å®¹: ${supportType}`, true);
            addMessage("æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚ãã®èª²é¡Œã«ã¤ã„ã¦ä¸€ç·’ã«è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚è©³ç´°ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚", false);
        }
        
        // æ—¥ã®å®Œäº†ãƒã‚§ãƒƒã‚¯
        function checkDayCompletion() {
            const day = weekData.days[weekData.currentDay];
            const completedCount = day.completed.length;
            const totalCount = day.todos.length;
            
            if (completedCount === totalCount && totalCount > 0) {
                day.isCompleted = true;
                const message = chatPatterns.completion.message
                    .replace('{completed}', completedCount)
                    .replace('{total}', totalCount);
                addMessage(message, false);
            } else {
                // ä»–ã®ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèª
                addMessage("ä»–ã®ã‚¿ã‚¹ã‚¯ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚", false);
                setTimeout(() => {
                    showRemainingTasks(day);
                }, 1000);
            }
            
            updateSummary();
            renderCalendar();
        }
        
        // æ®‹ã‚Šã‚¿ã‚¹ã‚¯è¡¨ç¤º
        function showRemainingTasks(day) {
            const remainingTasks = day.todos.filter((task, index) => 
                !day.completed.includes(index)
            );
            
            if (remainingTasks.length > 0) {
                const choices = remainingTasks.map((task, index) => {
                    const originalIndex = day.todos.indexOf(task);
                    return {
                        text: task,
                        action: () => selectTask(originalIndex)
                    };
                });
                
                choices.push({
                    text: "ä»Šæ—¥ã¯ã“ã“ã¾ã§",
                    action: () => endDayChat()
                });
                
                addChoices(choices);
            }
        }
        
        // æ—¥ã®ãƒãƒ£ãƒƒãƒˆçµ‚äº†
        function endDayChat() {
            addMessage("ä»Šæ—¥ã¯ã“ã“ã¾ã§ã«ã—ã¾ã™", true);
            addMessage("ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼ã¾ãŸæ˜æ—¥é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚", false);
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addMessage(text, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.textContent = text;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // å±¥æ­´ã«ä¿å­˜
            if (weekData.currentDay !== null) {
                weekData.chatHistory[weekData.currentDay].messages.push({
                    text: text,
                    isUser: isUser,
                    timestamp: new Date()
                });
            }
        }
        
        // é¸æŠè‚¢è¿½åŠ 
        function addChoices(choices) {
            const chatMessages = document.getElementById('chatMessages');
            const choicesDiv = document.createElement('div');
            choicesDiv.className = 'choices';
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = choice.text;
                button.onclick = () => {
                    choice.action();
                    choicesDiv.style.display = 'none';
                };
                choicesDiv.appendChild(button);
            });
            
            chatMessages.appendChild(choicesDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å‡¦ç†
        function handleUserInput() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            
            if (text) {
                addMessage(text, true);
                input.value = '';
                
                // ç°¡å˜ãªå¿œç­”
                setTimeout(() => {
                    addMessage("ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚", false);
                }, 500);
            }
        }
        
        // ã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateSummary() {
            const completedDaysCount = weekData.days.filter(day => day.isCompleted).length;
            const totalTasks = weekData.days.reduce((sum, day) => sum + day.todos.length, 0);
            const completedTasks = weekData.days.reduce((sum, day) => sum + day.completed.length, 0);
            const achievementRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('completedDays').textContent = `${completedDaysCount}/7`;
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('achievementRate').textContent = `${achievementRate}%`;
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
            document.getElementById('progressFill').style.width = `${achievementRate}%`;
        }
        
        // TO DOç·¨é›†æ©Ÿèƒ½
        function openTodoEditor() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0;">
                        <h2 style="margin: 0; font-size: 1.5rem;">âœï¸ é€±é–“TO DOç·¨é›†</h2>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">å„æ›œæ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’è‡ªç”±ã«ç·¨é›†ã§ãã¾ã™</p>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div id="todoEditorContent"></div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="this.closest('[style*=fixed]').remove()" 
                                    style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                            <button onclick="saveTodoChanges()" 
                                    style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            renderTodoEditor();
            
            // ä¿å­˜å‡¦ç†
            window.saveTodoChanges = function() {
                saveTodoEditorChanges();
                modal.remove();
                delete window.saveTodoChanges;
            };
        }
        
        // TO DOç·¨é›†ç”»é¢ã®æç”»
        function renderTodoEditor() {
            const content = document.getElementById('todoEditorContent');
            content.innerHTML = '';
            
            weekData.days.forEach((day, dayIndex) => {
                const dayEditor = document.createElement('div');
                dayEditor.style.cssText = `
                    margin-bottom: 25px;
                    padding: 20px;
                    border: 2px solid #e9ecef;
                    border-radius: 10px;
                `;
                
                dayEditor.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #333; font-size: 1.2rem;">
                            ${day.dayName}æ›œæ—¥ (${day.date.getMonth() + 1}/${day.date.getDate()})
                        </h3>
                        <button onclick="addNewTodo(${dayIndex})" 
                                style="padding: 5px 12px; background: #007bff; color: white; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                            â• ã‚¿ã‚¹ã‚¯è¿½åŠ 
                        </button>
                    </div>
                    
                    <div id="todoList-${dayIndex}"></div>
                `;
                
                content.appendChild(dayEditor);
                renderDayTodos(dayIndex);
            });
        }
        
        // å„æ—¥ã®TO DOä¸€è¦§ã‚’æç”»
        function renderDayTodos(dayIndex) {
            const todoList = document.getElementById(`todoList-${dayIndex}`);
            const day = weekData.days[dayIndex];
            
            todoList.innerHTML = '';
            
            if (day.todos.length === 0) {
                todoList.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px; border: 2px dashed #ddd; border-radius: 8px;">
                        ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œâ• ã‚¿ã‚¹ã‚¯è¿½åŠ ã€ã§ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
                    </div>
                `;
                return;
            }
            
            day.todos.forEach((todo, todoIndex) => {
                const todoItem = document.createElement('div');
                todoItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 12px;
                    margin-bottom: 10px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border: 1px solid #e9ecef;
                `;
                
                const isCompleted = day.completed.includes(todoIndex);
                const isInProgress = day.inProgress.includes(todoIndex);
                
                let statusIcon = 'â°';
                let statusColor = '#007bff';
                
                if (isCompleted) {
                    statusIcon = 'âœ…';
                    statusColor = '#28a745';
                } else if (isInProgress) {
                    statusIcon = 'ğŸ”„';
                    statusColor = '#ffc107';
                }
                
                todoItem.innerHTML = `
                    <span style="font-size: 1.2rem; margin-right: 10px; color: ${statusColor};">${statusIcon}</span>
                    <input type="text" value="${todo}" 
                           onchange="updateTodoText(${dayIndex}, ${todoIndex}, this.value)"
                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-right: 10px;">
                    <button onclick="deleteTodo(${dayIndex}, ${todoIndex})" 
                            style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                        ğŸ—‘ï¸
                    </button>
                `;
                
                todoList.appendChild(todoItem);
            });
        }
        
        // æ–°ã—ã„TO DOè¿½åŠ 
        window.addNewTodo = function(dayIndex) {
            const todoText = prompt('æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (todoText && todoText.trim()) {
                weekData.days[dayIndex].todos.push(todoText.trim());
                renderDayTodos(dayIndex);
            }
        };
        
        // TO DOãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
        window.updateTodoText = function(dayIndex, todoIndex, newText) {
            if (newText.trim()) {
                weekData.days[dayIndex].todos[todoIndex] = newText.trim();
            }
        };
        
        // TO DOå‰Šé™¤
        window.deleteTodo = function(dayIndex, todoIndex) {
            if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const day = weekData.days[dayIndex];
                
                // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
                day.todos.splice(todoIndex, 1);
                day.completed = day.completed.filter(i => i !== todoIndex).map(i => i > todoIndex ? i - 1 : i);
                day.inProgress = day.inProgress.filter(i => i !== todoIndex).map(i => i > todoIndex ? i - 1 : i);
                
                renderDayTodos(dayIndex);
            }
        };
        
        // TO DOç·¨é›†å†…å®¹ã‚’ä¿å­˜
        function saveTodoEditorChanges() {
            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚¿ã‚¹ã‚¯ãŒå¤‰æ›´ã•ã‚ŒãŸãŸã‚ï¼‰
            weekData.chatHistory = {};
            
            // UIæ›´æ–°
            renderCalendar();
            updateSummary();
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            saveData();
            
            // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (weekData.currentDay !== null) {
                const selectedDay = weekData.days[weekData.currentDay];
                updateChatHeader(selectedDay);
                startDayChat(selectedDay, weekData.currentDay);
            }
            
            alert('âœ… TO DOã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }
        
        // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´
        function initializeWeek() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            
            weekData.startDate = monday;
            weekData.days = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                
                weekData.days.push({
                    date: date,
                    dayName: dayNames[date.getDay()],
                    todos: [], // ç©ºã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã§é–‹å§‹
                    completed: [],
                    inProgress: [],
                    notes: {},
                    isCompleted: false
                });
            }
            
            updateWeekInfo();
            renderCalendar();
            updateSummary();
        }
        
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ©Ÿèƒ½
        function loadSampleData() {
            if (confirm('ã‚µãƒ³ãƒ—ãƒ«ã®TO DOãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰')) {
                weekData.days.forEach((day, index) => {
                    day.todos = sampleTodos[index] || [];
                    day.completed = [];
                    day.inProgress = [];
                    day.isCompleted = false;
                });
                
                weekData.chatHistory = {};
                
                renderCalendar();
                updateSummary();
                saveData();
                
                alert('âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
            }
        }
        let gapi_loaded = false;
        let calendar_api_ready = false;
        
        // Google Calendar APIåˆæœŸåŒ–
        function initializeGoogleCalendar() {
            gapi.load('client:auth2', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: 'YOUR_API_KEY', // Google Cloud Consoleã§å–å¾—
                    clientId: 'YOUR_CLIENT_ID', // Google Cloud Consoleã§å–å¾—
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
                    scope: 'https://www.googleapis.com/auth/calendar'
                });
                
                calendar_api_ready = true;
                console.log('âœ… Google Calendar APIåˆæœŸåŒ–å®Œäº†');
                
                // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                updateCalendarButtons();
            } catch (error) {
                console.error('âŒ Google Calendar APIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
        async function signInToGoogle() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signIn();
                console.log('âœ… Googleãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
                updateCalendarButtons();
                return true;
            } catch (error) {
                console.error('âŒ Googleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
        async function addTaskToCalendar(dayIndex, taskIndex) {
            if (!calendar_api_ready) {
                alert('Google Calendar APIãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const authInstance = gapi.auth2.getAuthInstance();
            if (!authInstance.isSignedIn.get()) {
                const success = await signInToGoogle();
                if (!success) return;
            }
            
            const day = weekData.days[dayIndex];
            const task = day.todos[taskIndex];
            
            // ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ™‚é–“ï¼ˆãã®æ—¥ã®9:00ã«è¨­å®šï¼‰
            const startTime = new Date(day.date);
            startTime.setHours(9, 0, 0, 0);
            
            // ã‚¤ãƒ™ãƒ³ãƒˆã®çµ‚äº†æ™‚é–“ï¼ˆ1æ™‚é–“å¾Œï¼‰
            const endTime = new Date(startTime);
            endTime.setHours(10, 0, 0, 0);
            
            const event = {
                'summary': `ğŸ“‹ TODO: ${task}`,
                'description': `TO DOãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯\n\nè©³ç´°:\n- æ—¥ä»˜: ${day.dayName}æ›œæ—¥\n- ã‚¿ã‚¹ã‚¯: ${task}\n- è¿½åŠ æ—¥æ™‚: ${new Date().toLocaleString()}`,
                'start': {
                    'dateTime': startTime.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'end': {
                    'dateTime': endTime.toISOString(),
                    'timeZone': 'Asia/Tokyo'
                },
                'reminders': {
                    'useDefault': false,
                    'overrides': [
                        {'method': 'popup', 'minutes': 30}
                    ]
                }
            };
            
            try {
                const response = await gapi.client.calendar.events.insert({
                    'calendarId': 'primary',
                    'resource': event
                });
                
                console.log('âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆæˆåŠŸ:', response);
                alert(`âœ… "${task}" ã‚’Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
                
                // ã‚¿ã‚¹ã‚¯ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ä¿å­˜
                if (!day.calendarEvents) day.calendarEvents = {};
                day.calendarEvents[taskIndex] = response.result.id;
                saveData();
                
            } catch (error) {
                console.error('âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æ›´æ–°
        async function updateTaskInCalendar(dayIndex, taskIndex, isCompleted) {
            const day = weekData.days[dayIndex];
            const task = day.todos[taskIndex];
            
            if (!day.calendarEvents || !day.calendarEvents[taskIndex]) {
                return; // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„
            }
            
            const eventId = day.calendarEvents[taskIndex];
            
            try {
                // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
                const event = await gapi.client.calendar.events.get({
                    'calendarId': 'primary',
                    'eventId': eventId
                });
                
                // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ï¼ˆå®Œäº†ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã‚‹ï¼‰
                const summary = isCompleted 
                    ? `âœ… TODOå®Œäº†: ${task}`
                    : `ğŸ“‹ TODO: ${task}`;
                
                // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°
                await gapi.client.calendar.events.update({
                    'calendarId': 'primary',
                    'eventId': eventId,
                    'resource': {
                        ...event.result,
                        'summary': summary
                    }
                });
                
                console.log('âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆæ›´æ–°æˆåŠŸ');
                
            } catch (error) {
                console.error('âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateCalendarButtons() {
            const calendarButtons = document.querySelectorAll('.calendar-sync-btn');
            const isSignedIn = calendar_api_ready && 
                              gapi.auth2 && 
                              gapi.auth2.getAuthInstance() && 
                              gapi.auth2.getAuthInstance().isSignedIn.get();
            
            calendarButtons.forEach(btn => {
                btn.disabled = !isSignedIn;
                btn.textContent = isSignedIn ? 'ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ' : 'ğŸ”’ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦';
            });
        }
        
        // .icsãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆï¼ˆOutlookæœ€é©åŒ–ç‰ˆï¼‰
        function generateICSFile(dayIndex, taskIndex) {
            const day = weekData.days[dayIndex];
            const task = day.todos[taskIndex];
            
            // ã‚¿ã‚¹ã‚¯ã®æ™‚é–“è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            showTimeSettingDialog(day, task, (startTime, duration, reminder) => {
                createICSFile(day, task, startTime, duration, reminder, dayIndex, taskIndex);
            });
        }
        
        // æ™‚é–“è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        function showTimeSettingDialog(day, task, callback) {
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            dialog.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%;">
                    <h3 style="margin-bottom: 20px; color: #333;">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š</h3>
                    <p style="margin-bottom: 15px; color: #666;">ã‚¿ã‚¹ã‚¯: ${task}</p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">é–‹å§‹æ™‚é–“:</label>
                        <input type="time" id="taskTime" value="09:00" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ‰€è¦æ™‚é–“:</label>
                        <select id="taskDuration" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="30">30åˆ†</option>
                            <option value="60" selected>1æ™‚é–“</option>
                            <option value="90">1æ™‚é–“30åˆ†</option>
                            <option value="120">2æ™‚é–“</option>
                            <option value="180">3æ™‚é–“</option>
                            <option value="240">4æ™‚é–“</option>
                            <option value="480">çµ‚æ—¥ï¼ˆ8æ™‚é–“ï¼‰</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼:</label>
                        <select id="taskReminder" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="0">ãªã—</option>
                            <option value="15">15åˆ†å‰</option>
                            <option value="30" selected>30åˆ†å‰</option>
                            <option value="60">1æ™‚é–“å‰</option>
                            <option value="120">2æ™‚é–“å‰</option>
                            <option value="1440">1æ—¥å‰</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="this.closest('[style*=fixed]').remove()" 
                                style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button onclick="confirmTimeSettings()" 
                                style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ 
                        </button>
                    </div>
                </div>
            `;
            
            // ç¢ºèªãƒœã‚¿ãƒ³ã®å‡¦ç†
            window.confirmTimeSettings = function() {
                const time = document.getElementById('taskTime').value;
                const duration = parseInt(document.getElementById('taskDuration').value);
                const reminder = parseInt(document.getElementById('taskReminder').value);
                
                dialog.remove();
                callback(time, duration, reminder);
                delete window.confirmTimeSettings;
            };
            
            document.body.appendChild(dialog);
        }
        
        // å®Ÿéš›ã®.icsãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        function createICSFile(day, task, startTime, duration, reminder, dayIndex, taskIndex) {
            // é–‹å§‹æ™‚é–“ã‚’è¨­å®š
            const [hours, minutes] = startTime.split(':');
            const startDate = new Date(day.date);
            startDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            // çµ‚äº†æ™‚é–“ã‚’è¨ˆç®—
            const endDate = new Date(startDate);
            endDate.setMinutes(endDate.getMinutes() + duration);
            
            // ICSå½¢å¼ã®æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆOutlookå¯¾å¿œï¼‰
            function formatICSDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hour = String(date.getHours()).padStart(2, '0');
                const min = String(date.getMinutes()).padStart(2, '0');
                const sec = String(date.getSeconds()).padStart(2, '0');
                
                return `${year}${month}${day}T${hour}${min}${sec}`;
            }
            
            // ã‚¿ã‚¹ã‚¯ã®é€²æ—çŠ¶æ³ã‚’å–å¾—
            const dayData = weekData.days[dayIndex];
            const isCompleted = dayData.completed.includes(taskIndex);
            const isInProgress = dayData.inProgress.includes(taskIndex);
            
            let status = 'â° TODO';
            let priority = 'NORMAL';
            
            if (isCompleted) {
                status = 'âœ… å®Œäº†';
                priority = 'LOW';
            } else if (isInProgress) {
                status = 'ğŸ”„ é€²è¡Œä¸­';
                priority = 'HIGH';
            }
            
            // ã‚«ãƒ†ã‚´ãƒªè¨­å®šï¼ˆOutlookã§ã®è‰²åˆ†ã‘ï¼‰
            const category = isCompleted ? 'GREEN' : isInProgress ? 'YELLOW' : 'BLUE';
            
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//TO DOãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ//NONSGML v1.0//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:todo-${dayIndex}-${taskIndex}-${Date.now()}@todoapp.local
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(startDate)}
DTEND:${formatICSDate(endDate)}
SUMMARY:${status}: ${task}
DESCRIPTION:ğŸ“‹ TO DOãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯\\n\\nğŸ“… æ—¥ä»˜: ${day.dayName}æ›œæ—¥ (${day.date.getMonth() + 1}/${day.date.getDate()})\\nğŸ“ ã‚¿ã‚¹ã‚¯: ${task}\\nâ° æ‰€è¦æ™‚é–“: ${duration}åˆ†\\nğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${status}\\n\\nğŸ¤– TO DOãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ç®¡ç†ä¸­
LOCATION:
PRIORITY:${priority}
STATUS:${isCompleted ? 'COMPLETED' : 'CONFIRMED'}
SEQUENCE:0
CATEGORIES:TODO,${category}
TRANSP:OPAQUE`;

            // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®è¿½åŠ 
            if (reminder > 0) {
                icsContent += `
BEGIN:VALARM
TRIGGER:-PT${reminder}M
DESCRIPTION:ğŸ“‹ ã‚¿ã‚¹ã‚¯ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼: ${task}
ACTION:DISPLAY
END:VALARM`;
            }

            icsContent += `
END:VEVENT
END:VCALENDAR`;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ—¥æœ¬èªå¯¾å¿œã§ç”Ÿæˆ
            const fileName = `TODO_${day.dayName}_${task.substring(0, 10).replace(/[^\w\s]/gi, '')}_${startTime.replace(':', '')}.ics`;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            setTimeout(() => {
                addMessage(`âœ… "${task}" ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼`, false);
                addMessage(`ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileName}`, false);
                addMessage(`ğŸ’¡ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦Outlookã§é–‹ã„ã¦ãã ã•ã„ã€‚`, false);
            }, 500);
        }
        const STORAGE_KEY = 'weekly_todo_data';
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        function saveData() {
            try {
                const dataToSave = {
                    weekData: weekData,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                return true;
            } catch (error) {
                console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    
                    // æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾©å…ƒ
                    if (parsed.weekData && parsed.weekData.days) {
                        parsed.weekData.days.forEach(day => {
                            day.date = new Date(day.date);
                        });
                        parsed.weekData.startDate = new Date(parsed.weekData.startDate);
                    }
                    
                    weekData = {...weekData, ...parsed.weekData};
                    console.log('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    return true;
                }
            } catch (error) {
                console.error('âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
            return false;
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
        function clearData() {
            if (confirm('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const dataToExport = {
                weekData: weekData,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `todo_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (imported.weekData) {
                        // æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾©å…ƒ
                        imported.weekData.days.forEach(day => {
                            day.date = new Date(day.date);
                        });
                        imported.weekData.startDate = new Date(imported.weekData.startDate);
                        
                        weekData = imported.weekData;
                        saveData();
                        
                        // UIæ›´æ–°
                        updateWeekInfo();
                        renderCalendar();
                        updateSummary();
                        
                        alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
                    }
                } catch (error) {
                    alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // è‡ªå‹•ä¿å­˜ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«è‡ªå‹•å®Ÿè¡Œï¼‰
        function enableAutoSave() {
            // ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã‚‹ãŸã³ã«è‡ªå‹•ä¿å­˜
            const originalSelectDay = selectDay;
            selectDay = function(dayIndex) {
                originalSelectDay(dayIndex);
                saveData();
            };
            
            const originalHandleTaskStatus = handleTaskStatus;
            handleTaskStatus = function(status, taskIndex) {
                originalHandleTaskStatus(status, taskIndex);
                saveData();
            };
        }
        
        // åˆæœŸåŒ–å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // ã¾ãšä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            const hasData = loadData();
            
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ
            if (!hasData) {
                initializeWeek();
            } else {
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯UIæ›´æ–°
                updateWeekInfo();
                renderCalendar();
                updateSummary();
            }
            
            // è‡ªå‹•ä¿å­˜ã‚’æœ‰åŠ¹åŒ–
            enableAutoSave();
        });
    </script>
</body>
</html>